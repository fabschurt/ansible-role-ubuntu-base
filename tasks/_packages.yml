---
- name: Upload custom APT source list (with backports disabled)
  tags: [packages]
  copy:
    src: pre_install/etc/apt/sources.list
    dest: /etc/apt/sources.list
    mode: 0644

# This is not an idempotent operation, but there's no real other choice for now,
# until the `apt` module supports a `clean` option
- name: Reset package tree
  tags: [packages]
  shell: apt-get clean; apt-get update
  args:
    warn: false

- name: Install needed packages
  tags: [packages]
  apt:
    name: '{{ item }}'
    state: present
  with_items: needed_packages

- name: Remove unneeded packages
  tags: [packages]
  apt:
    name: '{{ item }}'
    state: absent
    purge: true
  with_items: unneeded_packages

- name: Generate needed locales
  tags: [packages]
  locale_gen:
    name: '{{ item }}'
    state: present
  with_items: needed_locales

- name: Upgrade all packages
  tags: [packages, slow]
  apt:
    upgrade: 'yes'
